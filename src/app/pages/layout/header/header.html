<header class="layout-header">
  <div class="header-right">
    <div class="date-info">
      <span class="parasha">{{ parasha }}</span>
      <span class="dates">{{ dayOfWeek }} | {{ hebrewDate }} | {{ gregorianDate }}</span>
    </div>
  </div>
  <div class="search-container">
    <div class="search-bar">
      <input type="text" placeholder="חפש חבר קהילה, נדרים או הוצאות..." #searchInput (input)="onSearch(searchInput.value)" (focus)="onSearchFocus()" (blur)="hideDropdown()">
      <button class="search-clear" [class.visible]="searchText" (click)="searchInput.value = ''; clearSearch()">×</button>
    </div>
    @if (showDropdown && hasResults()) {
      <div class="search-dropdown">
        @if (searchResults.members.length > 0) {
          <div class="search-section">
            <div class="search-section-header">חברי קהילה</div>
            @for (item of searchResults.members; track item.id) {
              <div class="search-result" (click)="onResultClick(item, 'member')">
                <span class="result-name">{{ item.name }}</span>
              </div>
            }
          </div>
        }
        @if (searchResults.debts.length > 0) {
          <div class="search-section">
            <div class="search-section-header">חובות</div>
            @for (item of searchResults.debts; track item.id) {
              <div class="search-result" (click)="onResultClick(item, 'debt')">
                <span class="result-name">{{ item.name }}</span>
              </div>
            }
          </div>
        }
        @if (searchResults.receipts.length > 0) {
          <div class="search-section">
            <div class="search-section-header">קבלות</div>
            @for (item of searchResults.receipts; track item.id) {
              <div class="search-result" (click)="onResultClick(item, 'receipt')">
                <span class="result-name">{{ item.name }}</span>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>
  <div class="header-left">
    <button class="site-btn">
      <svg class="globe-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
      </svg>
      אתר בית הכנסת
    </button>
    <div class="notification-bell" (click)="toggleNotifications()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
      </svg>
      @if (totalNotifications > 0) {
        <span class="notification-dot"></span>
      }
    </div>

    <!-- Notification Dropdown -->
    <div class="notification-dropdown" [class.open]="showNotifications">
      <div class="notification-dropdown-header">
        <h3>הודעות</h3>
        @if (notifications.length > 0) {
          <button class="btn-mark-all" (click)="markAllAsRead()" [disabled]="isMarkingAllRead">
            @if (isMarkingAllRead) {
              <i class="fa-solid fa-spinner fa-spin"></i>
            }
            סמן הכל כנקרא
          </button>
        }
      </div>

      <div class="notification-dropdown-content">
        @if (isLoadingNotifications) {
          <div class="notification-loading">
            <i class="fa-solid fa-spinner fa-spin"></i>
          </div>
        } @else if (notifications.length === 0) {
          <div class="notification-empty">
            <p>אין הודעות חדשות</p>
          </div>
        } @else {
          @for (notification of notifications; track notification.id) {
            <div class="notification-item">
              <div class="notification-item-content">
                <div class="notification-item-header">
                  <span class="notification-title">{{ notification.title }}</span>
                  <span class="notification-time">{{ formatNotificationTime(notification.created_at) }}</span>
                </div>
                <a class="notification-link" (click)="onNotificationAction(notification)">
                  @if (notification.type === 'member') {
                    עבור לכרטיס חבר קהילה
                  } @else {
                    עבור לעמוד הכנסות
                  }
                  <img src="/assets/img/icons/external.svg">
                </a>
              </div>
              <button class="notification-mark-btn" (click)="markAsRead(notification)" [class.marking]="markingReadId === notification.id">
                <span class="mark-circle">
                  @if (markingReadId === notification.id) {
                    <svg class="checkmark" viewBox="0 0 24 24">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                  }
                </span>
              </button>
            </div>
          }
        }
      </div>

      @if (totalNotifications > 7) {
        <div class="notification-dropdown-footer">
          <a class="show-more-link" (click)="goToNotifications()">הצג עוד</a>
        </div>
      }
    </div>
    <div class="vertical-divider"></div>
    <div class="user-section">
      <div class="user-trigger" (click)="toggleUserMenu()">
        <div class="user-avatar">
          @if (userService.user()?.avatar) {
            <img [src]="userService.user()?.avatar" alt="avatar">
          } @else {
            <img src="/assets/img/icons/user_default_avatar.svg" alt="avatar">
          }
        </div>
        <div class="user-info-compact">
          <span class="user-name">{{ userService.user()?.name }}</span>
          @if (packageName) {
            <span class="user-badge">{{ packageName }}</span>
          }
        </div>
      </div>
      <div class="user-dropdown-overlay" [class.open]="showUserMenu" (click)="showUserMenu = false"></div>
      <div class="user-dropdown" [class.open]="showUserMenu">
        <div class="user-dropdown-content">
          <button class="logout-btn" (click)="onLogout()">צא מהחשבון</button>
          <div class="user-dropdown-right">
            <div class="dropdown-row">
              <span class="dropdown-user-name">{{ userService.user()?.name }}</span>
              <div class="dropdown-avatar">
                @if (userService.user()?.avatar) {
                  <img [src]="userService.user()?.avatar" alt="avatar">
                } @else {
                  <img src="/assets/img/icons/user_default_avatar.svg" alt="avatar">
                }
              </div>
            </div>
            <div class="dropdown-row">
              <span class="dropdown-user-email">{{ userService.user()?.email }}</span>
              @if (packageName) {
                <span class="dropdown-badge">{{ packageName }}</span>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Pro Banner -->
<div class="pro-banner">
  <span class="warning-icon">⚠</span>
  <span>כמשתמש PRO נותרו לך עוד - 14 הודעות לשליחה. רוצה עוד 1000ל' שדרג היום ל- MAX !</span>
</div>
