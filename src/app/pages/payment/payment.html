<div class="payment-dialog">
  <!-- Header -->
  <div class="dialog-header">
    <button class="close-btn" (click)="onClose()">
      <img src="assets/img/icons/close.svg" alt="" class="close-icon">
    </button>
    <h2>חיוב מהיר חדש</h2>
  </div>

  <!-- Steps -->
  <div class="steps-container">
    @for (step of steps; track step.number) {
      <div class="step" [class]="getStepClass(step.number)">
        <span class="step-number">
          @if (step.number < currentStep) {
            <i class="fa-solid fa-check"></i>
          } @else {
            {{ step.number }}
          }
        </span>
        <span class="step-label">{{ step.label }}</span>
      </div>
      @if (step.number < steps.length) {
        <div class="step-line" [class.completed]="step.number < currentStep"></div>
      }
    }
  </div>

  <!-- Content -->
  @if (isProcessing) {
    <div class="processing-container">
      <div class="processing-spinner"></div>
      <p class="processing-text">יוצר קשר עם חברת האשראי - אנא המתן</p>
    </div>
  } @else if (currentStep === 4) {
    @if (chargeError) {
      <div class="error-container">
        <div class="error-icon">
          <i class="fa-solid fa-xmark"></i>
        </div>
        <p class="error-message">{{ chargeError }}</p>
        <button class="btn-back" (click)="currentStep = 3">
          חזרה לשלב הקודם
        </button>
      </div>
    } @else {
      <div class="success-container">
        <div class="success-icon">
          <i class="fa-solid fa-check"></i>
        </div>
        <p class="success-message">
          הפעולה בוצעה בהצלחה@if (createReceipt && chargeResponse?.receipt?.id) { והקבלה נוצרה אוטומטית!}
          @if (createReceipt && chargeResponse?.receipt?.id) {
            <br>
            להורדת הקבלה לחץ כאן.
          }
        </p>
        @if (createReceipt && chargeResponse?.receipt?.id) {
          <button class="btn-download" (click)="downloadInvoice()">
            להורדת הקבלה
          </button>
        }
        @if (createReceipt && chargeResponse?.receipt?.id) {
          <p class="invoices-link">
            את כל הקבלות ניתן למצוא גם בעמוד <a href="/incomes">הכנסות</a>
          </p>
        }
      </div>
    }
  } @else {
    <div class="dialog-content">
      <!-- Left Side: Transaction Summary -->
      <div class="summary-wrapper">
        <div class="summary-section">
          <h3>סיכום פרטי העסקה</h3>
          <div class="summary-row">
            <span class="label">תיאור העסקה:</span>
            <span class="value">{{ transaction.description || '-------' }}</span>
          </div>
          <div class="summary-row">
            <span class="label">סכום לתשלום:</span>
            <span class="value">{{ transaction.amount | number:'1.0-2' }} ש"ח</span>
          </div>
          <div class="summary-row">
            <span class="label">מספר תשלומים:</span>
            <span class="value">{{ transaction.installments | number:'1.0-0' }}</span>
          </div>
          <div class="summary-row">
            <span class="label">מע"מ ({{ transaction.vatPercent }}%)</span>
            <span class="value">{{ transaction.vat | number:'1.0-2' }} ש"ח</span>
          </div>

          <div class="summary-total">
            <span class="label">סה"כ:</span>
            <span class="value">{{ transaction.total | number:'1.0-2' }} ש"ח</span>
            <span class="note">(כולל מע"מ)</span>
          </div>

          <div class="receipt-toggle">
            <label class="toggle">
              <input type="checkbox" [(ngModel)]="createReceipt">
              <span class="slider"></span>
            </label>
            <span>צור קבלה בסיום</span>
          </div>

          <button 
            type="button"
            class="btn-continue" 
            (click)="onContinue()" 
            [disabled]="!canContinue() || isProcessing">
            {{ getContinueButtonText() }}
          </button>
        </div>

        <div class="ssl-badge">
          <i class="fa-solid fa-shield-halved"></i>
          <span>מאובטח ב-SSL</span>
        </div>
      </div>

      <!-- Right Side: Step Content -->
      <div class="form-wrapper">
        <div class="form-section">
          @switch (currentStep) {
            @case (1) {
              <app-step1-payer
                [payerDetails]="payerDetails"
                [memberName]="memberName"
                (payerDetailsChange)="onPayerDetailsChange($event)"
                (memberIdChange)="onMemberIdChange($event)"
                (memberNameChange)="memberName = $event">
              </app-step1-payer>
            }
            @case (2) {
              <app-step2-payment
                [paymentDetails]="paymentDetails"
                [memberId]="memberId"
                [payerName]="getPayerFullName()"
                (paymentDetailsChange)="onPaymentDetailsChange($event)"
                (validationStateChange)="onStep2ValidationStateChange($event)">
              </app-step2-payment>
            }
            @case (3) {
              <app-step3-invoice
                [payerDetails]="payerDetails"
                [paymentDetails]="paymentDetails"
                [transaction]="transaction"
                (receiptTypeChange)="onReceiptTypeChange($event)">
              </app-step3-invoice>
            }
          }
        </div>

        @if (currentStep > 1) {
          <button class="btn-back" (click)="onBack()">
            <i class="fa-solid fa-arrow-right"></i>
            חזרה לשלב הקודם
          </button>
        }
      </div>
    </div>
  }
</div>
