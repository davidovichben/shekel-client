<div class="payment-details-form">
  @if (chargeSuccess || newCardSaved || masavChargeSuccess) {
    <div class="charge-complete-view">
      <div class="card-saved-success">
        <i class="fa-solid fa-check-circle"></i>
        <span>החיוב בוצע בהצלחה</span>
        <p>ניתן להמשיך לשלב הבא</p>
      </div>
      <button class="btn-continue" (click)="onContinue()">
        <span>המשך לפרטי חשבונית</span>
        <i class="fa-solid fa-arrow-left"></i>
      </button>
    </div>
  } @else if (!paymentSubmitted && !(useNewCard && iframeUrl)) {
    <div class="form-row">
      <div class="form-group">
        <label>סכום לחיוב</label>
        <div class="amount-input">
          <input type="number" [(ngModel)]="paymentDetails.amount" name="amount" min="0.01" max="100000" step="0.01" (ngModelChange)="onAmountChange()" (focus)="onFocus($event)" placeholder="0">
          <span class="currency">₪</span>
        </div>
      </div>
      <div class="form-group">
        <label>מספר תשלומים</label>
        <input type="number" [(ngModel)]="paymentDetails.installments" name="installments" min="1" max="32" (ngModelChange)="onInstallmentsChange()" (focus)="onFocus($event)" placeholder="0">
      </div>
    </div>

    <div class="form-group full-width">
      <label>תיאור עסקה</label>
      <input type="text" [(ngModel)]="paymentDetails.description" name="description" (ngModelChange)="onInputChange()">
    </div>

    <div class="payment-method-section">
      <label class="section-label">אמצעי תשלום:</label>
      <div class="payment-method-options">
        <label class="radio-option">
          <input type="radio" name="paymentMethod" value="credit" [(ngModel)]="paymentDetails.paymentMethod" (ngModelChange)="onPaymentMethodChange()">
          <span>כרטיס אשראי</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="paymentMethod" value="standingOrder" [(ngModel)]="paymentDetails.paymentMethod" (ngModelChange)="onPaymentMethodChange()">
          <span>חיוב מס"ב</span>
        </label>
      </div>
    </div>

    @if (paymentDetails.paymentMethod === 'credit' && paymentDetails.amount > 0) {
      <div class="credit-card-section">
        <div class="use-saved-card-toggle">
          <label class="toggle">
            <input type="checkbox" [(ngModel)]="useNewCard" (ngModelChange)="onUseNewCardChange()">
            <span class="slider"></span>
          </label>
          <span>השתמש בכרטיס אשראי חדש</span>
        </div>

        @if (useNewCard) {
          <div class="new-card-form">
            @if (isLoadingIframe) {
              <div class="iframe-loading">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <span>טוען טופס תשלום...</span>
              </div>
            } @else {
              <div class="iframe-error">
                <span>שגיאה בטעינת טופס התשלום</span>
                <button class="btn-retry" (click)="loadIframeUrl()">נסה שוב</button>
              </div>
            }
          </div>
        } @else if (isLoadingCards) {
          <div class="loading-cards">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <span>טוען כרטיסי אשראי...</span>
          </div>
        } @else if (savedCards.length > 0) {
          <div class="saved-cards">
            @for (card of savedCards; track card.id) {
              <app-credit-card
                [card]="card"
                [selected]="selectedCardId === card.id"
                (select)="selectCard($event)">
              </app-credit-card>
            }
          </div>
          @if (selectedCardId) {
            <button class="btn-charge" (click)="chargeSelectedCard()" [disabled]="isCharging || !selectedCardId">
              @if (isCharging) {
                <i class="fa-solid fa-spinner fa-spin"></i>
                <span>מבצע חיוב...</span>
              } @else {
                <i class="fa-solid fa-credit-card"></i>
                <span>בצע חיוב</span>
              }
            </button>
            @if (chargeError) {
              <div class="charge-error">
                <i class="fa-solid fa-exclamation-circle"></i>
                <span>{{ chargeError }}</span>
              </div>
            }
          }
        } @else if (memberId && !isLoadingCards) {
          <div class="no-cards-message">
            <p>לא נמצאו כרטיסי אשראי שמורים עבור חבר זה</p>
            <p>אנא הוסף כרטיס אשראי חדש</p>
          </div>
        }
      </div>
    }

    @if (paymentDetails.paymentMethod === 'standingOrder' && paymentDetails.amount > 0) {
      <div class="masav-section">
        @if (isLoadingBankDetails) {
          <div class="loading-cards">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <span>טוען פרטי בנק...</span>
          </div>
        } @else if (bankDetails && !showNewBankForm) {
          <div class="bank-details-display">
            <h4>פרטי חשבון בנק</h4>
            <div class="bank-details-grid">
              <div class="bank-detail-item">
                <span class="label">שם מלא:</span>
                <span class="value">{{ bankDetails.fullName }}</span>
              </div>
              <div class="bank-detail-item">
                <span class="label">מספר בנק:</span>
                <span class="value">{{ bankDetails.bankNumber }}</span>
              </div>
              <div class="bank-detail-item">
                <span class="label">מספר סניף:</span>
                <span class="value">{{ bankDetails.branchNumber }}</span>
              </div>
              <div class="bank-detail-item">
                <span class="label">מספר חשבון:</span>
                <span class="value">{{ bankDetails.accountNumber }}</span>
              </div>
            </div>
            <button class="btn-charge" (click)="chargeMasav()" [disabled]="isMasavCharging">
              @if (isMasavCharging) {
                <i class="fa-solid fa-spinner fa-spin"></i>
                <span>מבצע חיוב...</span>
              } @else {
                <i class="fa-solid fa-building-columns"></i>
                <span>בצע חיוב מס"ב</span>
              }
            </button>
            @if (masavChargeError) {
              <div class="charge-error">
                <i class="fa-solid fa-exclamation-circle"></i>
                <span>{{ masavChargeError }}</span>
              </div>
            }
          </div>
        } @else {
          <div class="new-bank-form">
            <h4>הוספת פרטי בנק חדשים</h4>
            <div class="form-row">
              <div class="form-group">
                <label>שם מלא</label>
                <input type="text" [(ngModel)]="newBankDetails.fullName" name="fullName">
              </div>
              <div class="form-group">
                <label>תעודת זהות</label>
                <input type="text" [(ngModel)]="newBankDetails.idNumber" name="idNumber" class="ltr-input">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>מספר בנק</label>
                <input type="text" [(ngModel)]="newBankDetails.bankNumber" name="bankNumber" class="ltr-input">
              </div>
              <div class="form-group">
                <label>מספר סניף</label>
                <input type="text" [(ngModel)]="newBankDetails.branchNumber" name="branchNumber" class="ltr-input">
              </div>
              <div class="form-group">
                <label>מספר חשבון</label>
                <input type="text" [(ngModel)]="newBankDetails.accountNumber" name="accountNumber" class="ltr-input">
              </div>
            </div>
            <button class="btn-save-bank" (click)="saveBankDetails()" [disabled]="!canSaveBankDetails() || isSavingBankDetails">
              @if (isSavingBankDetails) {
                <i class="fa-solid fa-spinner fa-spin"></i>
                <span>שומר...</span>
              } @else {
                <i class="fa-solid fa-floppy-disk"></i>
                <span>שמור פרטי בנק</span>
              }
            </button>
          </div>
        }
      </div>
    }
  } @else if (useNewCard && iframeUrl && !paymentSubmitted) {
    <div class="iframe-view">
      <button class="btn-back" (click)="onBackToForm()">
        <i class="fa-solid fa-arrow-right"></i>
        <span>חזרה</span>
      </button>
      <app-tranzila-payment
        [url]="iframeUrl"
        height="350px"
        (paymentSuccess)="onCardStored($event)"
        (paymentError)="onCardStoreError($event)">
      </app-tranzila-payment>
    </div>
  } @else if (!newCardSaved) {
    <div class="payment-processing">
      <i class="fa-solid fa-spinner fa-spin"></i>
      <span>מאמת תשלום...</span>
      <p>אנא המתן בזמן שאנו מאמתים את התשלום</p>
    </div>
  } @else {
    <div class="card-saved-success">
      <i class="fa-solid fa-check-circle"></i>
      <span>כרטיס האשראי נשמר בהצלחה</span>
      <p>ניתן להמשיך לשלב הבא</p>
    </div>
  }
</div>
